<!DOCTYPE html>
<!--
    GPRO Race Analysis
    Copyright (C) 2026 Olegas Spausdinimas

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPRO Race Analysis & Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
    <script src="gpro_parser.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="analyze.js"></script>
    <script src="forecast.js"></script>
    <script src="stint_analysis.js"></script>
</head>
<body>
    <div class="container">
        <div id="dashboard" class="dashboard">
            <div class="dashboard-top">
                <div class="controls-column">
                    <div class="header" style="margin-bottom: 10px;">
                        <h1>GPRO Race Analysis Tool</h1>
                    </div>
                    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()" style="margin-bottom: 0;">
                        <h3>Select Data Folder or Drop Files</h3>
                        <p>Click to select folder or drag and drop files (JSON, HTML, .mhtml, .zip or .tar.gz)</p>
                        <input type="file" id="fileInput" multiple webkitdirectory style="display:none" onchange="handleFiles(this.files)">
                    </div>
                    <div style="text-align:center; display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;">
                        <button id="openFetcherBtn" onclick="openRaceFetcher()" style="padding: 5px 10px; cursor: pointer; background: #2196f3; color: white; border: none; border-radius: 4px;">API Fetch</button>
                        <button onclick="loadPresavedTracks()" style="padding: 5px 10px; cursor: pointer; background: #607d8b; color: white; border: none; border-radius: 4px;">Load Presaved</button>
                        <button onclick="exportAllData()" style="padding: 5px 10px; cursor: pointer; background: #4caf50; color: white; border: none; border-radius: 4px;">Export All Data</button>
                        <small><a href="#" onclick="clearData(); return false;" style="color: #65676b; text-decoration: none;">Clear Saved Data</a></small>
                    </div>
                    <div style="text-align:center; margin-top: 10px; margin-bottom: 10px;">
                        <button onclick="renderAllPartsAnalysis('mix')" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 8px;">Parts Overview</button>
                        <button onclick="renderTrackPartsMatrix()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Track Matrix</button>
                        <button onclick="renderFuelTyreAnalysis()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Fuel & Tyre</button>
                        <button onclick="openRainAnalysis()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Rain Analysis</button>
                        <button onclick="openStintAnalysis()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Stint Analysis</button>
                        <button onclick="openComparisonTool()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Compare Races</button>
                        <button onclick="openRaceForecast()" style="padding: 6px 12px; cursor: pointer; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; margin-left: 5px; margin-bottom: 8px;">Race Forecast</button>
                    </div>
                    <div id="trackSelectorContainer" class="controls-section" style="display:none;">
                        <label for="trackSelect" style="font-weight:bold; margin-bottom:10px;">Select Track:</label>
                        <select id="trackSelect" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem;"></select>
                        <div id="raceSelectorContainer" style="width: 100%; margin-top: 15px;"></div>
                    </div>
                </div>
                <div class="chart-section">
                    <div class="chart-header-controls">
                        <div class="legend-item"><span class="legend-icon rain"></span> Rain</div>
                        <div class="legend-item"><span class="legend-icon sun"></span> Sun</div>
                        <div class="legend-item"><span class="legend-icon cloud"></span> Cloud</div>
                        <div class="legend-item"><span class="legend-icon pit"></span> Pit Stop</div>
                        <div class="legend-item"><span class="legend-icon problem">üîß</span> Car Problem</div>
                        <div class="legend-item"><span class="legend-icon mistake">‚ö†Ô∏è</span> Mistake</div>
                        <div class="legend-item legend-separator">
                            <input type="checkbox" id="simpleChartToggle" onchange="toggleChartMode()">
                            <label for="simpleChartToggle" style="cursor:pointer; margin-left:5px;">Clear Lines</label>
                        </div>
                        <div id="chartControls" style="display: flex; gap: 15px; align-items: center;"></div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="posChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="cardsContainer" class="grid"></div>
        </div>

        <details id="debugLogContainer" class="debug-box" style="display:none;">
            <summary>Debug Log <button onclick="document.getElementById('debugLog').innerHTML = ''; return false;" style="float:right;font-size:0.8rem;cursor:pointer;background:#444;color:#fff;border:1px solid #666;padding:2px 5px;">Clear</button></summary>
            <div id="debugLog"></div>
        </details>
    </div>

    <div id="customTooltip" class="custom-tooltip"></div>

    <!-- Templates -->
    <template id="raceFetcherTemplate">
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3>Fetch Race Data via API</h3>
                <div class="subtitle">Download Race Analysis directly from GPRO</div>
                <button class="back-btn" style="margin-top:10px; padding:5px 10px; cursor:pointer; background:var(--accent); color:white; border:none; border-radius:4px;">Back to Dashboard</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">API Token:</label>
                    <input type="text" id="fetcherToken" placeholder="Paste Bearer Token here" style="width:100%; padding:8px; margin-bottom:10px; background:var(--bg-color); color:var(--text-primary); border:1px solid var(--border); border-radius:4px;">
                    <p style="font-size:0.8rem; color:var(--text-secondary);">Token is saved locally. Get it from GPRO App -> Misc -> API access.</p>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <div style="flex:1;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">Season (Optional):</label>
                        <input type="number" id="fetcherSeason" placeholder="e.g. 99" style="width:100%; padding:8px; background:var(--bg-color); color:var(--text-primary); border:1px solid var(--border); border-radius:4px;">
                    </div>
                    <div style="flex:1;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold;">Race (Optional):</label>
                        <input type="number" id="fetcherRace" placeholder="e.g. 8" style="width:100%; padding:8px; background:var(--bg-color); color:var(--text-primary); border:1px solid var(--border); border-radius:4px;">
                    </div>
                </div>
                <button id="doFetchBtn" style="padding:10px 20px; background:#4caf50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Fetch S/R Data</button>
                <button id="doFetchListBtn" style="padding:10px 20px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;">Fetch Available Races</button>
                <p id="fetcherLog" style="margin-top:20px; font-family:monospace; color: var(--text-secondary);">Ready.</p>
                <div id="fetcherResult" style="margin-top:20px;"></div>
            </div>
        </div>
    </template>

    <template id="comparisonSelectorTemplate">
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3>Select Races to Compare</h3>
                <button class="back-btn" style="margin-top:10px; padding:5px 10px; cursor:pointer; background:var(--accent); color:white; border:none; border-radius:4px;">Back to Dashboard</button>
                <button class="compare-btn" style="margin-top:10px; padding:5px 10px; cursor:pointer; background:#4caf50; color:white; border:none; border-radius:4px; margin-left:10px;">Compare Selected</button>
            </div>
            <div class="list-container" style="max-height: 500px; overflow-y: auto; padding: 10px;"></div>
        </div>
    </template>

    <template id="partsAnalysisTemplate">
        <div class="card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3>All Parts Analysis</h3>
                <div class="subtitle"></div>
                <div class="controls-container"></div>
                <button class="back-btn" style="margin-top:10px; padding:5px 10px; cursor:pointer; background:var(--accent); color:white; border:none; border-radius:4px;">Back to Dashboard</button>
            </div>
            <table class="setup-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(this.closest('table'), 0)">Track</th>
                        <th onclick="sortTable(this.closest('table'), 1)">Part</th>
                        <th onclick="sortTable(this.closest('table'), 2)">Level</th>
                        <th onclick="sortTable(this.closest('table'), 3)">Start Wear</th>
                        <th onclick="sortTable(this.closest('table'), 4)">Finish Wear</th>
                        <th onclick="sortTable(this.closest('table'), 5)">Used</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </template>
</body>
</html>